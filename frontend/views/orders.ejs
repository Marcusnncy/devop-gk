<%- include('../../frontend/views/partials/header') %>

<div class="container-fluid py-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 text-primary fw-bold">Quản lý đơn hàng</h1>
    <a href="/admin" class="btn btn-secondary">← Quay lại Dashboard</a>
  </div>

  <% if (orders.length === 0) { %>
    <div class="text-center py-5">
      <img src="https://cdni.iconscout.com/illustration/premium/thumb/no-data-found-5431289-4538821.png" width="250">
      <h4 class="text-muted mt-3">Chưa có đơn hàng nào</h4>
    </div>
  <% } else { %>
    <div class="table-responsive">
      <table class="table table-hover align-middle">
        <thead class="table-dark">
          <tr>
            <th>Mã đơn</th>
            <th>Khách hàng</th>
            <th>Số sản phẩm</th>
            <th>Tổng tiền</th>
            <th>Ngày đặt</th>
            <th>Trạng thái</th>
            <th>Hành động</th>
          </tr>
        </thead>
        <tbody>
          <% orders.forEach(order => { %>
            <tr>
              <td><strong><%= order.orderId %></strong></td>
              <td>
                <%= order.user?.username || 'Khách vãng lai' %><br>
                <small class="text-muted"><%= order.user?.email || '' %></small>
              </td>
              <td><%= order.items.length %> sản phẩm</td>
              <td class="text-danger fw-bold"><%= order.totalAmount.toLocaleString() %>₫</td>
              <td><%= new Date(order.createdAt).toLocaleDateString('vi-VN') %><br>
                  <small><%= new Date(order.createdAt).toLocaleTimeString('vi-VN') %></small>
              </td>
              <td>
                <% if (order.status === 'completed') { %>
                  <span class="badge bg-success fs-6">Đã thanh toán</span>
                <% } else { %>
                  <span class="badge bg-warning fs-6">Chờ xử lý</span>
                <% } %>
              </td>
              <td>
                <button class="btn btn-sm btn-info text-white" 
                        data-bs-toggle="modal" 
                        data-bs-target="#orderDetail<%= order._id %>">
                  Xem chi tiết
                </button>
              </td>
            </tr>

            <!-- Modal chi tiết đơn hàng -->
            <div class="modal fade" id="orderDetail<%= order._id %>" tabindex="-1">
              <div class="modal-dialog modal-lg">
                <div class="modal-content">
                  <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Chi tiết đơn hàng: <%= order.orderId %></h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p><strong>Khách hàng:</strong> <%= order.user?.username %> (<%= order.user?.email %>)</p>
                    <p><strong>Thời gian:</strong> <%= new Date(order.createdAt).toLocaleString('vi-VN') %></p>
                    <hr>
                    <% order.items.forEach(item => { %>
                      <div class="row mb-3 align-items-center">
                        <div class="col-3">
                          <img src="<%= item.image %>" class="img-fluid rounded" width="80">
                        </div>
                        <div class="col-9">
                          <h6><%= item.name %></h6>
                          <p class="mb-1">
                            <small><%= item.price.toLocaleString() %>₫ × <%= item.quantity %> = 
                              <strong class="text-danger"><%= (item.price * item.quantity).toLocaleString() %>₫</strong>
                            </small>
                          </p>
                        </div>
                      </div>
                    <% }) %>
                    <hr>
                    <div class="text-end">
                      <h4 class="text-danger">Tổng cộng: <%= order.totalAmount.toLocaleString() %>₫</h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          <% }) %>
        </tbody>
      </table>
    </div>
  <% } %>
</div>

<%- include('../../frontend/views/partials/footer') %>