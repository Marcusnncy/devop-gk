<!-- frontend/views/partials/chatbot.ejs -->
<div id="chatbot-container" class="shadow-lg rounded-4 overflow-hidden" 
     style="position:fixed; bottom:20px; right:20px; width:380px; height:550px; z-index:9999; border:1px solid #e2e8f0; display:none;">
  <div class="bg-primary text-white p-4 d-flex justify-content-between align-items-center">
    <div>
      <h6 class="mb-0 fw-bold">lady Mode Assistant</h6>
      <small class="text-success"><i class="fas fa-circle"></i> Đang online</small>
    </div>
    <button onclick="toggleChat()" class="btn-close btn-close-white"></button>
  </div>

  <div id="chat-messages" class="p-4 bg-light" style="height:380px; overflow-y:auto;">
    <div class="text-center text-muted small my-3">
      <i class="fas fa-robot fa-2x mb-2"></i><br>
      Xin chào! Mình là trợ lý ảo của Ladymode
    </div>
  </div>

  <div class="p-3 border-top bg-white">
    <div class="input-group">
      <input type="text" id="user-input" class="form-control rounded-start-pill border-0" 
             placeholder="Nhập tin nhắn..." onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()" class="btn btn-primary rounded-end-pill">
        <i class="fas fa-paper-plane"></i>
      </button>
    </div>
  </div>
</div>

<!-- Nút mở chatbot -->
<div id="chatbot-toggle" onclick="toggleChat()" 
     style="position:fixed; bottom:20px; right:20px; width:60px; height:60px; 
            background:#3b82f6; border-radius:50%; box-shadow:0 8px 30px rgba(59,130,246,0.4);
            cursor:pointer; z-index:9998; display:flex; align-items:center; justify-content:center;">
  <i class="fas fa-comments fa-2x text-white"></i>
</div>

<script>
// Tạo sessionId duy nhất cho mỗi khách (dùng localStorage)
let sessionId = localStorage.getItem('chatSessionId');
if (!sessionId) {
  sessionId = 'guest_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  localStorage.setItem('chatSessionId', sessionId);
}

const responses = {
  "chào|hello|hi|xin chào": "Chào bạn! Lady Mode có thể giúp gì cho bạn hôm nay ạ?",
  "giá iphone|iphone bao nhiêu|16 pro max": "iPhone 16 Pro Max 256GB: 34.990.000₫\nGiá tốt nhất – Bảo hành chính hãng 12 tháng!",
  "giao hàng|ship|bao lâu": "Giao miễn phí toàn quốc\nNội thành: 24h | Ngoại tỉnh: 48h\nThanh toán khi nhận hàng (COD)",
  "bảo hành|bao hanh": "Bảo hành chính hãng 12 tháng\n1 đổi 1 trong 30 ngày nếu lỗi\nHỗ trợ phần mềm trọn đời",
  "thanh toán|momo|trả góp": "Thanh toán Momo giảm ngay 300k\nTrả góp 0% lãi suất\nHỗ trợ Home Credit, FE Credit",
  "có sẵn không|hết hàng chưa": "Tất cả sản phẩm đều CÓ SẴN và sẵn sàng giao ngay!",
  "cảm ơn|thanks|cám ơn": "Rất vui được hỗ trợ bạn! Chúc bạn mua sắm vui vẻ!"
};

// Hàm lưu tin nhắn vào MongoDB
async function saveMessageToDB(sender, message) {
  try {
    await fetch('/api/chat/save-message', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId, sender, message })
    });
  } catch (err) {
    console.log("Lưu chat thất bại (vẫn hoạt động bình thường)");
  }
}

// Gửi tin nhắn
async function sendMessage() {
  const input = document.getElementById('user-input');
  const msg = input.value.trim();
  if (!msg) return;

  addMessage(msg, 'user');
  await saveMessageToDB('user', msg); // LƯU TIN NHẮN KHÁCH
  input.value = '';

  setTimeout(async () => {
    let reply = "Mình chưa hiểu lắm, bạn hỏi cụ thể hơn được không ạ? Hoặc liên hệ hotline 1900 1234 nhé!";
    
    for (const [key, value] of Object.entries(responses)) {
      if (new RegExp(key, 'i').test(msg.toLowerCase())) {
        reply = value;
        break;
      }
    }

    addMessage(reply, 'bot');
    await saveMessageToDB('bot', reply); // LƯU TIN NHẮN BOT
  }, 800);
}

function addMessage(text, sender) {
  const chat = document.getElementById('chat-messages');
  const div = document.createElement('div');
  const safeText = (text || '').toString().replace(/\n/g, '<br>');
  
  div.className = sender === 'user' 
    ? 'bg-primary text-white rounded-3 p-3 mb-3 ms-auto text-end' 
    : 'bg-white rounded-3 p-3 mb-3 shadow-sm text-start';
  div.style.maxWidth = '85%';
  div.innerHTML = safeText;

  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function toggleChat() {
  const container = document.getElementById('chatbot-container');
  const toggle = document.getElementById('chatbot-toggle');
  if (container.style.display === 'block') {
    container.style.display = 'none';
    toggle.style.display = 'flex';
  } else {
    container.style.display = 'block';
    toggle.style.display = 'none';
  }
}

// Ẩn khung chat ban đầu
window.onload = () => {
  document.getElementById('chatbot-container').style.display = 'none';
};
</script>